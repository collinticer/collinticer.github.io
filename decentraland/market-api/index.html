<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Hello, world!</title>
    <style>
        .badge-eth {
            color: #FFF;
            background-color: rgb(212, 130, 23);
        }

        .badge-poly {
            color: #FFF;
            background-color: rgb(121, 17, 153);
        }

        .badge-common {
            color: #000;
            background-color: #abc1c1;
        }

        .badge-uncommon {
            color: #fff;
            background-color: #ed6d4f;
        }

        .badge-rare {
            color: #fff;
            background-color: #36cf75;
        }

        .badge-epic {
            color: #fff;
            background-color: #3d85e6;
        }

        .badge-legendary {
            color: #fff;
            background-color: #842dda;
        }

        .badge-mythic {
            color: #fff;
            background-color: #ff63e1;
        }

        .badge-unique {
            color: #000;
            background-color: #ffb626;
        }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="row justify-content-center mb-3"><div class="col"><input class="form-control form-control-lg" type="text" placeholder="Search" id="searchTerm"></div></div>
        <div id="appView"></div>
    </div>
    <template id="searchResultTemplate">
        <p class="alert alert-info text-center">You are searching for <b>{{ searchTerm }}</b><br><a onclick="showMainResults()" class="btn btn-sm btn-warning">Clear search</a></p>
    </template>
    <template id="resultsTemplate">
        <div class="row justify-content-center" id="productsList">
        </div>
        {{#if searchTerm }}
            <a onclick="loadMoreResults( '{{ searchTerm }}' )" class="btn btn-success btn-md">Load More</a>
        {{else}}
            <a onclick="loadMoreResults()" class="btn btn-success btn-md">Load More</a>
        {{/if}}
    </template>
    <template id="productTemplate">
        <div class="col-sm-3 mb-3">
            <div class="card">
                {{#if nft }}
                    <img class="card-img-top" src="{{ nft.image }}" alt="{{ nft.data.wearable.description }}" onclick="searchForTerm( '{{{ escape nft.name }}}' )">
                {{else}}
                    <img class="card-img-top" src="{{ thumbnail }}" alt="{{ data.wearable.description }}" onclick="searchForTerm( '{{{ escape name }}}' )">
                {{/if}}
                <div class="card-body">
                    {{#if nft }}
                        <h5 class="card-title"><a onclick="searchForTerm( '{{ nft.name }}' )" >{{ nft.name }}</a></h5>
                        <span class="badge badge-info">{{ divide order.price 1000000000000000000 }}</span>
                        {{#if nft.data.wearable }}
                            <p class="card-text">{{ nft.data.wearable.description }}</p>
                        {{/if}}
                        <a href="https://market.decentraland.org{{ nft.url }}" target="_blank">View on DCL Market</a><br>
                        <span class="badge badge-primary">{{ nft.category }}</span>
                        {{#when nft.network 'eq' 'MATIC' }}
                            <span class="badge badge-poly">Polygon</span>
                        {{/when}}
                        {{#when nft.network 'neq' 'MATIC' }}
                            <span class="badge badge-eth">Ethereum</span>
                        {{/when}}
                        <span class="badge badge-success">NFT</span>
                        <span class="badge badge-{{ nft.data.wearable.rarity }}">{{ nft.data.wearable.rarity }}</span>
                    {{else}}
                        <h5 class="card-title"><a onclick="searchForTerm( '{{ name }}' )" >{{ name }}</a></h5>
                        <span class="badge badge-info">{{ divide price 1000000000000000000 }}</span>
                        {{#if data.wearable }}
                            <p class="card-text">{{ data.wearable.description }}</p>
                        {{/if}}
                        <a href="https://market.decentraland.org{{ url }}" target="_blank">View on DCL Market</a><br>
                        <span class="badge badge-primary">{{ category }}</span>
                        {{#when network 'eq' 'MATIC' }}
                            <span class="badge badge-poly">Polygon</span>
                        {{/when}}
                        {{#when network 'neq' 'MATIC' }}
                            <span class="badge badge-eth">Ethereum</span>
                        {{/when}}
                        <span class="badge badge-success">Item</span>
                        <span class="badge badge-{{ data.wearable.rarity }}">{{ data.wearable.rarity }}</span>
                    {{/if}}
                </div>
            </div>
        </div>
    </template>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script>

        Handlebars.registerHelper( "when", function( operand_1, operator, operand_2, options ) {

            if( typeof operand_1 == 'boolean' )
            {
                operand_1 = operand_1.toString();
            }

            if( typeof operand_2 == 'boolean' )
            {
                operand_2 = operand_2.toString();
            }

            var operators = {
                'eq': function(l,r) { return l == r; },
                'neq': function(l,r) { return l != r; },
                'gt': function(l,r) { return Number(l) > Number(r); },
                'gte': function(l,r) { return Number(l) >= Number(r); },
                'lt': function(l,r) { return Number(l) < Number(r); },
                'lte': function(l,r) { return Number(l) <= Number(r); },
                'or': function(l,r) { return l || r; },
                'and': function(l,r) { return l && r; },
                '%': function(l,r) { return (l % r) === 0; }
            }, 
            result = operators[operator](operand_1,operand_2);

            if (result) return options.fn(this);
            else  return options.inverse(this);
        });

        Handlebars.registerHelper( 'times', function( n, block ) {
            var accum = '';
            for(var i = 0; i < n; ++i)
                accum += block.fn(i);
            return accum;
        });

        Handlebars.registerHelper( 'for', function( from, to, incr, block ) {
            var accum = '';
            for(var i = from; i < to; i += incr)
                accum += block.fn(i);
            return accum;
        });

        Handlebars.registerHelper( 'add', function( a, b ) {
            return Number(a) + Number(b);
        });

        Handlebars.registerHelper( 'divide', function( a, b ) {
            return Number(a) / Number(b);
        });

        Handlebars.registerHelper( 'fixed', function( a, b ) {
            return a.toFixed( b );
        });

        Handlebars.registerHelper('escape', function(variable) {
            return variable.replace(/(['"])/g, '\\$1');
        });

        window.app = window.app || {};
        window.app.ownerAddress = window.app.ownerAddress || '';
        window.app.resultsPerPage = window.app.resultsPerPage || 24;
        window.app.resultsToSkip = window.app.resultsToSkip || 0;
        window.app.searchTerm = window.app.searchTerm || '';

        $( '#searchTerm' ).on( 'input', function( e ){

            var searchTerm = $( '#searchTerm' ).val();
            window.app.searchTerm = searchTerm;

            if( searchTerm.length > 0 )
            {
                searchForTerm( searchTerm );
            }
            else
            {
                showMainResults();
            }
            
        });

        $( function(){

            showMainResults();
            
        })

        var loadMoreResults = function( searchTerm )
        {
            window.app.resultsPerPage = 24;
            window.app.resultsToSkip = window.app.resultsToSkip + window.app.resultsPerPage;

            if( typeof searchTerm != 'undefined' && searchTerm.length > 0 )
            {
                searchForTerm( searchTerm, true);
            }
            else
            {
                showMainResults( true );
            }
        }

        var searchForTerm = function( searchTerm, keepCurrentResults = false )
        {
            var template = Handlebars.compile( $( '#searchResultTemplate' ).html() );
            var resultsTemplate = Handlebars.compile( $( '#resultsTemplate' ).html() );
            var productTemplate = Handlebars.compile( $( '#productTemplate' ).html() );

            if( keepCurrentResults == false )
            {
                $( '#appView' ).html( template( { searchTerm: searchTerm } ) );
                $( '#appView' ).append( resultsTemplate( { searchTerm: window.app.searchTerm } ) );

                window.app.resultsPerPage = 24;
                window.app.resultsToSkip = 0;
            }

            var urlEncodedSearch = encodeURIComponent( searchTerm );

            $.ajax( {
                url: 'https://nft-api.decentraland.org/v1/nfts?first=' + window.app.resultsPerPage + '&skip=' + window.app.resultsToSkip + '&sortBy=recently_listed&category=wearable&isOnSale=true&search=' + urlEncodedSearch,
                success: function( data )
                {
                    var returnData = data;
                    var products = returnData.data;
                    
                    products.forEach( function( product ){
                        console.log( product );
                        $( '#productsList' ).append( productTemplate( product ) );
                    } )
                }
            } )

            $.ajax( {
                url: 'https://nft-api.decentraland.org/v1/items?first=' + window.app.resultsPerPage + '&skip=' + window.app.resultsToSkip + '&sortBy=recently_reviewed&isOnSale=true&search=' + urlEncodedSearch,
                success: function( data )
                {
                    var returnData = data;
                    var products = returnData.data;
                    
                    products.forEach( function( product ){
                        console.log( product );
                        $( '#productsList' ).append( productTemplate( product ) );
                    } )
                }
            } )
        }

        var showMainResults = function( keepCurrentResults = false )
        {
            window.app.searchTerm = '';
            var resultsTemplate = Handlebars.compile( $( '#resultsTemplate' ).html() );
            var template = Handlebars.compile( $( '#productTemplate' ).html() );

            if( keepCurrentResults == false )
            {
                $( '#appView' ).html( resultsTemplate( { searchTerm: window.app.searchTerm } ) );

                window.app.resultsPerPage = 24;
                window.app.resultsToSkip = 0;
            }

            $.ajax( {
                url: 'https://nft-api.decentraland.org/v1/nfts?first=' + window.app.resultsPerPage + '&skip=' + window.app.resultsToSkip + '&sortBy=recently_listed&category=wearable&isOnSale=true',
                success: function( data )
                {
                    var returnData = data;
                    var products = returnData.data;
                    
                    products.forEach( function( product ){
                        console.log( product );
                        
                        $( '#productsList' ).append( template( product ) );
                    } );
                }
            } )
            
            $.ajax( {
                url: 'https://nft-api.decentraland.org/v1/items?first=' + window.app.resultsPerPage + '&skip=' + window.app.resultsToSkip + '&sortBy=recently_listed&category=wearable&isOnSale=true',
                success: function( data )
                {
                    var returnData = data;
                    var products = returnData.data;
                    
                    products.forEach( function( product ){
                        console.log( product );

                        $( '#productsList' ).append( template( product ) );
                    } );
                }
            } )
        }
    </script>
  </body>
</html>